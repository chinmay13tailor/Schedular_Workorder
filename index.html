<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Work Order Scheduler</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--cyan:#06b6d4;--amber:#f59e0b;--red:#ef4444;--slate:#374151}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:1fr 320px;gap:16px;min-height:100vh;padding:16px}
  header{grid-column:1/-1;display:flex;gap:10px;align-items:center;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .spacer{flex:1}
  .btn,.input,textarea,select{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #calendar{min-height:560px}
  .side{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;position:sticky;top:16px;height:fit-content}
  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

  .filters{grid-column:1/-1;display:flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .filters label{font-size:12px;color:#64748b;margin-right:4px}

  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-inprogress{background:var(--amber)}
  .status-completed{background:var(--green)}
  .status-cancelled{background:var(--red)}
  .sub{display:block;font-weight:600;opacity:.95}
  .tiny{display:block;font-weight:600;opacity:.8;font-size:12px}

  .muted{color:#64748b}
  #loading{font-size:12px;color:#64748b;margin-left:8px}

  .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(620px,92vw);background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:0 24px 48px rgba(0,0,0,.18)}
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}

  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}

  .fc-toolbar-chunk.legends{display:flex;gap:14px;align-items:center;margin-left:8px}
  .legend-box{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
  .legend-planned{background:var(--blue)}
  .legend-inprogress{background:var(--amber)}
  .legend-completed{background:var(--green)}
  .legend-cancelled{background:var(--red)}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <!-- Filters -->
  <div class="filters">
    <label>Operator</label>
    <select id="filtOp" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <label>Machine</label>
    <select id="filtMa" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <label>Status</label>
    <select id="filtSt" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Planned</option>
      <option>In-Progress</option>
      <option>Completed</option>
      <option>Cancelled</option>
    </select>

    <button class="btn ghost" id="btnApplyFilters" type="button">Update</button>
    <button class="btn" id="btnResetFilters" type="button">Reset</button>
  </div>

  <div class="card"><div id="calendar"></div></div>

  <aside class="side">
    <h3 class="h6">Work order</h3>
    <div id="details" class="empty">Select a work order on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn danger"  id="btnCancel" type="button">Cancel</button>
      <button class="btn ghost"   id="btnEdit"   type="button">Update</button>
      <button class="btn primary" id="btnNew"    type="button">New</button>
    </div>
  </aside>
</div>

<!-- Create/Update Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900" id="modalTitle">Add work order</div>
      <button class="btn" id="closeModal" type="button">Close</button>
    </header>
    <div class="body">
      <div>
        <label>WO ID</label>
        <input id="fId" class="input" type="text" placeholder="WO-0001">
      </div>
      <div>
        <label>Job</label>
        <input id="fJob" class="input" type="text" placeholder="Job/Part name">
      </div>

      <div class="row-full">
        <label>Operator(s)</label>
        <div class="email-row">
          <input id="opOne" class="input" type="text" placeholder="Type a name and click +">
          <button class="btn ghost" id="addOpBtn" type="button">+</button>
        </div>
        <div id="opChips" class="chips"></div>
      </div>

      <div>
        <label>Machine</label>
        <input id="fMachine" class="input" type="text" placeholder="e.g., LATHE-02">
      </div>
      <div>
        <label>Priority</label>
        <select id="fPriority" class="input">
          <option>Low</option><option selected>Medium</option><option>High</option>
        </select>
      </div>

      <div>
        <label>Start</label>
        <input id="fTimeStart" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>End</label>
        <input id="fTimeEnd" class="input" type="time" value="11:00">
      </div>

      <div>
        <label>Status</label>
        <select id="fStatus" class="input">
          <option>Planned</option>
          <option>In-Progress</option>
          <option>Completed</option>
          <option>Cancelled</option>
        </select>
      </div>
      <div>
        <label>Quantity</label>
        <input id="fQty" class="input" type="number" min="0" step="1" placeholder="0">
      </div>

      <div class="row-full">
        <label>Notes</label>
        <textarea id="fNotes" class="input" rows="2" placeholder="Optional"></textarea>
      </div>

      <div class="row-full muted" id="fDateHint">Date: â€”</div>
    </div>
    <footer>
      <button class="btn primary" id="saveSession" type="button">Save</button>
    </footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
/************ CONFIG ************/
var ORIGIN    = "https://plantwiz.pimateck.in";
var API_BASE  = ORIGIN + "/api";
var DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
var JWT       = new URLSearchParams(location.search).get("token")  || "";

// Attribute flags with WO_ prefix
var ATTR_WO_SAVE_FLAG    = "WO_Save_Button";      // on create
var ATTR_WO_UPDATE_FLAG  = "WO_Update_Buttton";   // on update/cancel (exact spelling)
var ATTR_WO_UPDATE_TS    = "WO_Update_Timestamp"; // base ts to update (on update/cancel)

// Telemetry keys for Work Orders
var KEYS = [
  "WO_Id","WO_Operators","WO_Start","WO_End","WO_Machine","WO_Job",
  "WO_Priority","WO_Status","WO_Quantity","WO_Notes"
];

/************ HELPERS ************/
function $(s){ return document.querySelector(s); }
function loading(t){ $("#loading").textContent = t || ""; }
var state = {
  calendar:null, clickedDate:null, lastRange:null, selectedEvent:null, mode:"create",
  operators: [], // chips list
  filters: { op:"__ALL__", ma:"__ALL__", st:"__ALL__" },
  lastEventsFull: []
};
function mergeDateTime(baseDate, hhmm){
  var parts = String(hhmm||"00:00").split(":"); var h = parseInt(parts[0]||"0",10), m = parseInt(parts[1]||"0",10);
  var d = new Date(baseDate); d.setHours(h||0, m||0, 0, 0); return d.getTime();
}
function msToHHMM(ms){ var d = new Date(ms); return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0'); }
function escapeHtml(s){ return String(s||"").replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function colorByStatus(s){
  var v = String(s||"Planned").toLowerCase();
  if (v==="cancelled") return "status-cancelled";
  if (v==="in-progress" || v==="inprogress") return "status-inprogress";
  if (v==="completed") return "status-completed";
  return "status-planned";
}
function fmtTimeFull(ms){
  var d = new Date(ms), h = d.getHours()%12||12;
  var ampm = d.getHours()>=12 ? "PM":"AM";
  return String(h).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+" "+ampm;
}
function eventContent(arg){
  var p = arg.event.extendedProps;
  var time  = fmtTimeFull(p.WO_Start);
  var title = p.WO_Job || p.WO_Id || "WO";
  return { html: '<span>'+escapeHtml(time)+' â€” '+escapeHtml(title)+'</span>' };
}

/************ READ ************/
function readRange(rangeStart, rangeEnd){
  if(!JWT){ return Promise.reject(new Error("Missing JWT (?token=)")); }
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
          + "?keys=" + encodeURIComponent(KEYS.join(",")) +
            "&startTs=" + rangeStart.getTime() +
            "&endTs="   + rangeEnd.getTime() +
            "&limit=5000";
  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error("Timeseries read failed: "+t); }))
    .then(tsObj => {
      var map = {};
      Object.keys(tsObj || {}).forEach(k => {
        (tsObj[k]||[]).forEach(p => {
          var ts = Number(p.ts);
          var rec = map[ts] || (map[ts] = { ts: ts });
          rec[k] = p.value;
        });
      });
      var out = [];
      Object.keys(map).forEach(tsStr => {
        var r = map[tsStr];
        var st = Number(r.WO_Start || r.ts);
        var en = Number(r.WO_End || (st+60*60*1000));
        if (!st || !en) return;
        var title = String(r.WO_Job || r.WO_Id || "WO");
        out.push({
          id: "ts-"+r.ts,
          title: title,
          start: new Date(st),
          end:   new Date(en),
          classNames: ["event", colorByStatus(r.WO_Status)],
          extendedProps: {
            WO_Id: r.WO_Id || "",
            WO_Operators: r.WO_Operators || "",
            WO_Start: st,
            WO_End: en,
            WO_Machine: r.WO_Machine || "",
            WO_Job: r.WO_Job || "",
            WO_Priority: r.WO_Priority || "Medium",
            WO_Status: r.WO_Status || "Planned",
            WO_Quantity: r.WO_Quantity || "",
            WO_Notes: r.WO_Notes || "",
            __ts: r.ts
          }
        });
      });
      out.sort((a,b)=>a.start-b.start);
      return out;
    });
}

/************ FILTERS ************/
function populateFilters(events){
  var ops = new Set(), mas = new Set(), sts = new Set();
  events.forEach(ev=>{
    var p = ev.extendedProps||{};
    if (p.WO_Operators){
      String(p.WO_Operators).split(",").map(s=>s.trim()).filter(Boolean).forEach(o=>ops.add(o));
    }
    if (p.WO_Machine) mas.add(String(p.WO_Machine));
    if (p.WO_Status)  sts.add(String(p.WO_Status));
  });
  function fill(sel, set){
    var el = $(sel); var val = el.value || "__ALL__";
    el.innerHTML = '<option value="__ALL__">All</option>' +
      Array.from(set).sort().map(v=>'<option>'+escapeHtml(v)+'</option>').join('');
    if ([...set].includes(val)) el.value = val; else el.value="__ALL__";
  }
  fill("#filtOp", ops); fill("#filtMa", mas); fill("#filtSt", sts);
}
function applyFilters(events){
  var op = $("#filtOp").value, ma = $("#filtMa").value, st = $("#filtSt").value;
  state.filters = { op, ma, st };
  return events.filter(ev=>{
    var p = ev.extendedProps||{};
    var okOp = (op==="__ALL__" || (p.WO_Operators||"").split(",").map(s=>s.trim()).includes(op));
    var okMa = (ma==="__ALL__" || String(p.WO_Machine)===ma);
    var okSt = (st==="__ALL__" || String(p.WO_Status)===st);
    return okOp && okMa && okSt;
  });
}
$("#btnApplyFilters").addEventListener("click", function(){
  var filtered = applyFilters(state.lastEventsFull);
  state.calendar.removeAllEvents(); state.calendar.addEventSource(filtered);
  loading("Loaded "+filtered.length+" work orders");
});
$("#btnResetFilters").addEventListener("click", function(){
  $("#filtOp").value="__ALL__"; $("#filtMa").value="__ALL__"; $("#filtSt").value="__ALL__";
  state.filters = { op:"__ALL__", ma:"__ALL__", st:"__ALL__" };
  state.calendar.removeAllEvents(); state.calendar.addEventSource(state.lastEventsFull);
  loading("Loaded "+state.lastEventsFull.length+" work orders");
});

/************ AUTO-REFRESH (5s, 3 min max) ************/
var _autoTimer=null,_autoDeadline=0;
function stopAutoRefresh(){ if(_autoTimer){clearInterval(_autoTimer);_autoTimer=null;} }
function startAutoRefresh(expectedTs, predicate){
  stopAutoRefresh(); _autoDeadline = Date.now() + 3*60*1000;
  _autoTimer = setInterval(function(){
    if (Date.now()>_autoDeadline){ stopAutoRefresh(); loading("Stopped: timeout waiting for telemetry update"); return; }
    if (!state.lastRange) return;
    readRange(state.lastRange.start, state.lastRange.end)
      .then(function(events){
        state.lastEventsFull = events.slice();
        populateFilters(events);
        var filtered = applyFilters(events);
        state.calendar.removeAllEvents(); state.calendar.addEventSource(filtered);
        $("#details").className="empty"; $("#details").textContent="Select a work order"; $("#sideActions").style.display="none";
        loading("Loaded "+filtered.length+" work orders â€” auto-refreshingâ€¦");
        if (expectedTs!=null){
          var found = events.find(ev => String(ev.extendedProps.__ts) === String(expectedTs));
          if (found){
            if (typeof predicate==="function"){ try{ if(predicate(found)){ stopAutoRefresh(); loading("Update detected âœ“"); } }catch(e){} }
            else { stopAutoRefresh(); loading("Update detected âœ“"); }
          }
        }
      })
      .catch(function(err){ console.error(err); loading("Auto-refresh error: "+(err.message||err)); });
  }, 5000);
}

/************ WRITE ************/
function writeAttributes(payload, opts){
  if(!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/SERVER_SCOPE";
  var body = {
    WO_Id:        payload.WO_Id,
    WO_Operators: payload.WO_Operators,
    WO_Start:     payload.WO_Start,
    WO_End:       payload.WO_End,
    WO_Machine:   payload.WO_Machine,
    WO_Job:       payload.WO_Job,
    WO_Priority:  payload.WO_Priority || "Medium",
    WO_Status:    payload.WO_Status || "Planned",
    WO_Quantity:  payload.WO_Quantity || "",
    WO_Notes:     payload.WO_Notes || ""
  };
  if (opts && opts.mode==="create"){
    body[ATTR_WO_SAVE_FLAG] = false; // WO_Save_Button=false
  } else if (opts && (opts.mode==="update" || opts.mode==="cancel")){
    body[ATTR_WO_UPDATE_FLAG] = true; // WO_Update_Buttton=true
    if (payload[ATTR_WO_UPDATE_TS]) body[ATTR_WO_UPDATE_TS] = payload[ATTR_WO_UPDATE_TS]; // WO_Update_Timestamp
  }
  return fetch(url,{
    method:"POST",
    headers:{ "X-Authorization":"Bearer "+JWT, "Content-Type":"application/json" },
    body: JSON.stringify(body)
  }).then(res=>res.ok?null:res.text().then(t=>{throw new Error("Attribute write failed: "+t);}));
}

/************ DETAILS ************/
function showDetails(ev){
  state.selectedEvent = ev;
  var p = ev.extendedProps; function fmt(v){ return v?new Date(Number(v)).toLocaleString():"-"; }
  $("#details").className = "";
  $("#details").innerHTML =
    '<div class="kpi">'+
      '<span>Base ts</span><span>'+escapeHtml(String(p.__ts||"-"))+'</span>'+
      '<span>WO ID</span><span>'+escapeHtml(p.WO_Id||"-")+'</span>'+
      '<span>Job</span><span>'+escapeHtml(p.WO_Job||"-")+'</span>'+
      '<span>Operators</span><span>'+escapeHtml(p.WO_Operators||"-")+'</span>'+
      '<span>Machine</span><span>'+escapeHtml(p.WO_Machine||"-")+'</span>'+
      '<span>Priority</span><span>'+escapeHtml(p.WO_Priority||"-")+'</span>'+
      '<span>Status</span><span>'+escapeHtml(p.WO_Status||"Planned")+'</span>'+
      '<span>Quantity</span><span>'+escapeHtml(p.WO_Quantity||"-")+'</span>'+
      '<span>Start</span><span>'+fmt(p.WO_Start)+'</span>'+
      '<span>End</span><span>'+fmt(p.WO_End)+'</span>'+
      '<span>Notes</span><span>'+escapeHtml(p.WO_Notes||"-")+'</span>'+
    '</div>';
  $("#sideActions").style.display = "flex";
}

/************ MODAL + OPERATORS CHIPS ************/
var overlay = $("#overlay");
function busy(on){
  ["saveSession","btnCancel","btnEdit","btnNew"].forEach(id=>{ var el=$( "#"+id ); if(el) el.disabled=!!on;});
}
function refreshOpChips(){
  var box=$("#opChips"); box.innerHTML=""; state.operators.forEach(function(name,idx){
    var chip=document.createElement("span"); chip.className="chip";
    chip.innerHTML='<span>'+escapeHtml(name)+'</span><button type="button" aria-label="Remove">âœ•</button>';
    chip.querySelector("button").addEventListener("click",function(){ state.operators.splice(idx,1); refreshOpChips(); });
    box.appendChild(chip);
  });
}
function addOneOperator(){
  var v=($("#opOne").value||"").trim(); if(!v) return;
  if(state.operators.includes(v)){ alert("Already added: "+v); return; }
  state.operators.push(v); $("#opOne").value=""; refreshOpChips();
}
$("#addOpBtn").addEventListener("click", addOneOperator);
$("#opOne").addEventListener("keydown", function(e){ if (e.key==="Enter"){ e.preventDefault(); addOneOperator(); } });

$("#closeModal").addEventListener("click", function(){ overlay.style.display="none"; });

$("#btnNew").addEventListener("click", function(){
  openModalForDate(new Date());
});

$("#saveSession").addEventListener("click", function(){
  if (state.mode==="update") onUpdate();
  else onCreate();
});

$("#btnEdit").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a work order first."); return; }
  var p = state.selectedEvent.extendedProps;
  state.mode="update"; $("#modalTitle").textContent="Update work order"; $("#saveSession").textContent="Update";

  var base = new Date(p.WO_Start); state.clickedDate = new Date(base.getFullYear(), base.getMonth(), base.getDate());

  $("#fId").value   = p.WO_Id || "";
  $("#fJob").value  = p.WO_Job || "";
  state.operators   = (p.WO_Operators||"").split(",").map(s=>s.trim()).filter(Boolean);
  refreshOpChips(); $("#opOne").value="";
  $("#fMachine").value  = p.WO_Machine || "";
  $("#fPriority").value = p.WO_Priority || "Medium";
  $("#fTimeStart").value= msToHHMM(p.WO_Start);
  $("#fTimeEnd").value  = msToHHMM(p.WO_End);
  $("#fStatus").value   = p.WO_Status || "Planned";
  $("#fQty").value      = p.WO_Quantity || "";
  $("#fNotes").value    = p.WO_Notes || "";
  $("#fDateHint").textContent = "Date: " + state.clickedDate.toDateString();

  overlay.style.display="flex";
});

$("#btnCancel").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a work order first."); return; }
  if(!confirm("Cancel this work order?")) return;

  var p = state.selectedEvent.extendedProps;
  var payload = {
    WO_Id: p.WO_Id || "",
    WO_Operators: p.WO_Operators || "",
    WO_Start: p.WO_Start, WO_End: p.WO_End,
    WO_Machine: p.WO_Machine || "",
    WO_Job: p.WO_Job || "",
    WO_Priority: p.WO_Priority || "Medium",
    WO_Status: "Cancelled",
    WO_Quantity: p.WO_Quantity || "",
    WO_Notes: p.WO_Notes || ""
  };
  // include WO_Update_Timestamp to retarget row in RC
  payload[ATTR_WO_UPDATE_TS] = p.__ts;

  loading("Cancellingâ€¦"); busy(true);
  writeAttributes(payload, { mode:"cancel" })
    .then(function(){
      startAutoRefresh(payload[ATTR_WO_UPDATE_TS], function(found){
        return String(found.extendedProps.WO_Status).toLowerCase()==="cancelled";
      });
    })
    .catch(err=>{ console.error(err); alert(err.message||"Failed to cancel"); })
    .finally(()=>{ busy(false); });
});

/************ CREATE / UPDATE ************/
function openModalForDate(jsDate){
  state.mode="create";
  state.clickedDate = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate());
  $("#modalTitle").textContent="Add work order"; $("#saveSession").textContent="Save";
  $("#fDateHint").textContent = "Date: " + state.clickedDate.toDateString();
  $("#fId").value=""; $("#fJob").value=""; state.operators=[]; refreshOpChips(); $("#opOne").value="";
  $("#fMachine").value=""; $("#fPriority").value="Medium";
  $("#fTimeStart").value="09:00"; $("#fTimeEnd").value="11:00";
  $("#fStatus").value="Planned"; $("#fQty").value=""; $("#fNotes").value="";
  overlay.style.display="flex";
}
function collectPayload(base){
  return {
    WO_Id: ($("#fId").value||"").trim(),
    WO_Operators: state.operators.join(", "),
    WO_Start: mergeDateTime(base, $("#fTimeStart").value),
    WO_End:   mergeDateTime(base, $("#fTimeEnd").value),
    WO_Machine: ($("#fMachine").value||"").trim(),
    WO_Job: ($("#fJob").value||"").trim(),
    WO_Priority: $("#fPriority").value||"Medium",
    WO_Status: $("#fStatus").value||"Planned",
    WO_Quantity: ($("#fQty").value||"").trim(),
    WO_Notes: ($("#fNotes").value||"").trim()
  };
}
function validatePayload(p){
  var must = [
    ["WO ID", p.WO_Id],
    ["Job", p.WO_Job],
    ["At least one operator", p.WO_Operators],
    ["Machine", p.WO_Machine]
  ];
  for (var i=0;i<must.length;i++){ if(!must[i][1]) return "Please enter "+must[i][0]; }
  if (p.WO_End <= p.WO_Start) return "End time must be after Start time.";
  return "";
}
function onCreate(){
  var base = state.clickedDate || new Date();
  var payload = collectPayload(base);
  var err = validatePayload(payload); if (err){ alert(err); return; }

  loading("Savingâ€¦"); busy(true);
  writeAttributes(payload, { mode:"create" })
    .then(function(){
      overlay.style.display="none";
      // After RC writes telemetry at ts = WO_Start
      startAutoRefresh(payload.WO_Start, null);
    })
    .catch(function(e){ console.error(e); alert(e.message||"Failed to save"); })
    .finally(function(){ busy(false); });
}
function onUpdate(){
  if(!state.selectedEvent || !state.selectedEvent.extendedProps){ alert("No work order selected for update."); return; }
  var base = state.clickedDate || new Date();
  var payload = collectPayload(base);

  var baseTs = state.selectedEvent.extendedProps.__ts;
  if(!baseTs){ alert("Missing base timestamp for update. Please reselect the event."); return; }
  // include WO_Update_Timestamp
  payload[ATTR_WO_UPDATE_TS] = baseTs;

  var err = validatePayload(payload); if (err){ alert(err); return; }

  loading("Updatingâ€¦"); busy(true);
  writeAttributes(payload, { mode:"update" })
    .then(function(){
      overlay.style.display="none";
      // Stop when the row at WO_Update_Timestamp reflects these fields
      startAutoRefresh(payload[ATTR_WO_UPDATE_TS], function(found){
        var p = found.extendedProps || {};
        var opsOk = String(p.WO_Operators||"") === String(payload.WO_Operators||"");
        var jobOk = String(p.WO_Job||"") === String(payload.WO_Job||"");
        var stOk  = String(p.WO_Status||"") === String(payload.WO_Status||"");
        var sOk   = Number(p.WO_Start||0) === Number(payload.WO_Start||0);
        var eOk   = Number(p.WO_End||0)   === Number(payload.WO_End||0);
        return opsOk && jobOk && stOk && sOk && eOk;
      });
    })
    .catch(function(e){ console.error(e); alert(e.message||"Failed to update"); })
    .finally(function(){ busy(false); });
}

/************ BOOT ************/
function startCalendar(){
  if (!window.FullCalendar){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">FullCalendar failed to load.</span></div>'; return;
  }
  if (!JWT){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">Missing JWT (?token=â€¦)</span></div>'; return;
  }
  var calEl = $("#calendar");
  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    headerToolbar: { left: "prev,next today", center: "title", right: "" },
    height: "auto",
    eventContent: eventContent,
    dateClick: function(info){ openModalForDate(info.date); },
    eventClick: function(info){ showDetails(info.event); },
    datesSet: function(info){
      loading("Loadingâ€¦");
      state.lastRange = { start: info.start, end: info.end };
      readRange(info.start, info.end)
        .then(function(events){
          state.lastEventsFull = events.slice();
          populateFilters(events);
          var filtered = applyFilters(events);
          state.calendar.removeAllEvents(); state.calendar.addEventSource(filtered);
          $("#details").className="empty"; $("#details").textContent="Select a work order";
          $("#sideActions").style.display="none";
          loading("Loaded "+filtered.length+" work orders");
        })
        .catch(function(err){
          console.error(err); loading(err.message || "Failed to load");
          state.calendar.removeAllEvents();
        });
    }
  });
  state.calendar.render();

  // Legends on toolbar right
  const toolbar = calEl.querySelector(".fc-toolbar-chunk:nth-child(3)");
  if (toolbar){
    const legends = document.createElement("div");
    legends.className = "fc-toolbar-chunk legends";
    legends.innerHTML = `
      <span><span class="legend-box legend-planned"></span> Planned</span>
      <span><span class="legend-box legend-inprogress"></span> In-Progress</span>
      <span><span class="legend-box legend-completed"></span> Completed</span>
      <span><span class="legend-box legend-cancelled"></span> Cancelled</span>
    `;
    toolbar.appendChild(legends);
  }
}
if (document.readyState==="complete" || document.readyState==="interactive") setTimeout(startCalendar,0);
else document.addEventListener("DOMContentLoaded", startCalendar);
</script>
</body>
</html>
